# Architecture Fix - Clean Separation of Concerns

## Problem Identified ?

The Bot project was directly accessing the PostgreSQL database, which violated Clean Architecture principles:

```
? Discord Bot ? PostgreSQL Database (Direct Access)
```

This created tight coupling between the presentation layer (Bot) and the data layer (Database).

## Solution Implemented ?

Restored proper Clean Architecture with clear separation:

```
? Discord Bot ? REST API ? PostgreSQL Database
```

---

## Changes Made

### 1. **Nightstorm.Bot** (Presentation Layer)
**Removed:**
- ? `Nightstorm.Data` project reference
- ? `Microsoft.EntityFrameworkCore.Design` package
- ? Database connection string from `appsettings.json`
- ? `DbContext` registration from `Program.cs`
- ? `TestDbConnection.cs` file

**Added:**
- ? `GameApi:BaseUrl` configuration (points to API)

**Result:** Bot is now a pure presentation layer that will communicate with the API.

---

### 2. **Nightstorm.API** (Application/Infrastructure Layer)
**Added:**
- ? Database connection string in `appsettings.json`
- ? `DbContext` registration in `Program.cs`
- ? Entity Framework Core configuration
- ? CORS policy for Bot/Web clients
- ? Health check endpoint (`/api/health`)
- ? Controllers support

**Result:** API is now the single point of data access and game logic.

---

## Current Architecture

```
???????????????????????????????????????????????????????????????
?                    Presentation Layer                        ?
???????????????????????????????????????????????????????????????
?  Nightstorm.Bot (Discord Client)                            ?
?  - Discord slash commands                                    ?
?  - User interactions                                         ?
?  - HTTP client to communicate with API                       ?
?                                                              ?
?  Nightstorm.Web (React SPA - Future)                        ?
?  - Web interface                                             ?
?  - SignalR client for real-time updates                     ?
???????????????????????????????????????????????????????????????
                            ? HTTP/SignalR
???????????????????????????????????????????????????????????????
?                  Application Layer                           ?
???????????????????????????????????????????????????????????????
?  Nightstorm.API (Game Engine)                               ?
?  - REST API endpoints                                        ?
?  - SignalR hubs (real-time)                                 ?
?  - Game logic orchestration                                  ?
?  - Authentication & Authorization                            ?
???????????????????????????????????????????????????????????????
                            ? DbContext
???????????????????????????????????????????????????????????????
?                 Infrastructure Layer                         ?
???????????????????????????????????????????????????????????????
?  Nightstorm.Data                                            ?
?  - Entity Framework Core                                     ?
?  - Repositories                                              ?
?  - Database migrations                                       ?
???????????????????????????????????????????????????????????????
                            ? Npgsql
???????????????????????????????????????????????????????????????
?  PostgreSQL Database (Docker)                               ?
?  - Characters, Items, Guilds, Quests, Monsters             ?
???????????????????????????????????????????????????????????????
```

---

## Dependencies After Fix

### Nightstorm.Bot
```
Nightstorm.Bot
  ??? Nightstorm.Core (domain entities only)
  ??? Discord.Net
```

### Nightstorm.API
```
Nightstorm.API
  ??? Nightstorm.Core (domain entities)
  ??? Nightstorm.Data (data access)
  ??? EF Core + Npgsql
```

### Nightstorm.Data
```
Nightstorm.Data
  ??? Nightstorm.Core (domain entities)
  ??? EF Core + Npgsql
```

---

## How to Run Migrations Now

Since Bot no longer has database access, use **API** as the startup project:

```cmd
dotnet ef migrations add MigrationName --project src\Nightstorm.Data --startup-project src\Nightstorm.API

dotnet ef database update --project src\Nightstorm.Data --startup-project src\Nightstorm.API
```

---

## Testing the Setup

### 1. Test Database Connection via API

**Start the API:**
```cmd
cd C:\Users\Justas\Source\Repos\NightstormReborn
dotnet run --project src\Nightstorm.API
```

**Test the health endpoint:**
```cmd
curl https://localhost:7001/api/health
```

**Expected Response:**
```json
{
  "status": "healthy",
  "database": "PostgreSQL",
  "timestamp": "2025-01-22T07:35:00.000Z"
}
```

### 2. Bot Communication Flow (Future Implementation)

```csharp
// In Bot: Send request to API
var client = new HttpClient();
var response = await client.GetAsync("https://localhost:7001/api/characters/123");
var character = await response.Content.ReadFromJsonAsync<Character>();
```

---

## Next Steps

### 1. Implement API Endpoints

Create controllers in `Nightstorm.API/Controllers/`:

```
src/Nightstorm.API/Controllers/
  ??? CharactersController.cs
  ??? ItemsController.cs
  ??? QuestsController.cs
  ??? GuildsController.cs
  ??? CombatController.cs
```

### 2. Create HTTP Client in Bot

Create `GameApiClient` service in Bot to communicate with API:

```csharp
public class GameApiClient
{
    private readonly HttpClient _httpClient;
    
    public async Task<Character> GetCharacterAsync(Guid id)
    {
        return await _httpClient.GetFromJsonAsync<Character>($"/api/characters/{id}");
    }
}
```

### 3. Implement SignalR Hubs in API

For real-time features:
- `GameHub` - General game updates
- `CombatHub` - Real-time combat
- `ChatHub` - In-game chat

### 4. Connect Bot to API

Update Discord command handlers to call API endpoints instead of database directly.

---

## Benefits of This Architecture

? **Separation of Concerns**
- Bot handles UI/UX (Discord interactions)
- API handles business logic and data access
- Data layer handles persistence

? **Scalability**
- Bot and API can scale independently
- Multiple bots can connect to same API
- Web client can be added without changes to API

? **Security**
- Database credentials only in API
- Bot cannot bypass business logic
- Centralized authentication/authorization

? **Testability**
- Bot can be tested with mock API
- API can be tested without Bot
- Clear boundaries for unit/integration tests

? **Flexibility**
- Swap Discord for Slack/Teams without touching API
- Change database without touching Bot
- Add new clients (mobile, web) easily

---

## Configuration Files

### Bot: appsettings.json
```json
{
  "GameApi": {
    "BaseUrl": "https://localhost:7001"
  },
  "DiscordBot": {
    "Token": "YOUR_BOT_TOKEN_HERE",
    // ... other Discord settings
  }
}
```

### API: appsettings.json
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5432;Database=NightstormDb;Username=nightstorm;Password=NightstormDev2024"
  },
  "AllowedHosts": "*"
}
```

---

## Summary

? **Architecture Fixed**: Restored proper Clean Architecture
? **Build Successful**: All projects compile
? **Database Access**: Moved from Bot to API
? **Migrations**: Now run with API as startup project
? **Next Steps**: Implement API endpoints and Bot HTTP client

The project now follows Clean Architecture principles with proper separation of concerns! ??
